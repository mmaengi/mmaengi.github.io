<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ë„ ê¸°ë°˜ ì»¤ë®¤ë‹ˆí‹° ë°ëª¨</title>
    
    <!-- Tailwind CSS (ìŠ¤íƒ€ì¼ë§) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS (ì§€ë„ ìŠ¤íƒ€ì¼) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <style>
        /* ì§€ë„ê°€ ì „ì²´ í™”ë©´ì„ ì±„ìš°ë„ë¡ ì„¤ì • */
        #map { height: 100vh; width: 100%; z-index: 0; }
        .modal { z-index: 1000; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="absolute top-0 left-0 w-full bg-white/90 backdrop-blur-sm shadow-md z-50 px-4 py-3 flex justify-between items-center">
        <h1 class="text-xl font-bold text-blue-600">ğŸ—ºï¸ Map Community Demo</h1>
        <div class="text-sm text-gray-500">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ í•€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>
    </nav>

    <!-- ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>

    <!-- 1. í¬ìŠ¤íŠ¸ ì‘ì„± ëª¨ë‹¬ (ìˆ¨ê¹€ ìƒíƒœ) -->
    <div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform transition-all scale-100">
            <h2 class="text-lg font-bold mb-4">ìƒˆë¡œìš´ ì¥ì†Œ ê¸°ë¡í•˜ê¸°</h2>
            <form id="postForm">
                <input type="hidden" id="clickLat">
                <input type="hidden" id="clickLng">
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">ì œëª©</label>
                    <input type="text" id="postTitle" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required placeholder="ì¥ì†Œ ì´ë¦„ì´ë‚˜ ì œëª©">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">ë‚´ìš©</label>
                    <textarea id="postContent" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-24" required placeholder="ì—¬ê¸°ëŠ” ì–´ë–¤ ê³³ì¸ê°€ìš”?"></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('createModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">ì·¨ì†Œ</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. í¬ìŠ¤íŠ¸ ì¡°íšŒ ë° ëŒ“ê¸€ ëª¨ë‹¬ (ìˆ¨ê¹€ ìƒíƒœ) -->
    <div id="viewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
            <div class="border-b pb-4 mb-4">
                <div class="flex justify-between items-start">
                    <h2 id="viewTitle" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="deletePost()" class="text-red-500 text-xs hover:underline">ì‚­ì œ</button>
                </div>
                <p id="viewDate" class="text-xs text-gray-400 mb-2"></p>
                <p id="viewContent" class="text-gray-700 whitespace-pre-wrap bg-gray-50 p-3 rounded"></p>
                <input type="hidden" id="currentPostId">
            </div>

            <!-- ëŒ“ê¸€ ì˜ì—­ -->
            <div>
                <h3 class="font-bold text-gray-700 mb-2">ëŒ“ê¸€ <span id="commentCount" class="text-blue-500">0</span></h3>
                <div id="commentsList" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                    <!-- ëŒ“ê¸€ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                </div>
                
                <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                <form id="commentForm" class="flex gap-2">
                    <input type="text" id="commentInput" class="flex-1 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required>
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">ë“±ë¡</button>
                </form>
            </div>

            <div class="mt-4 text-right">
                <button onclick="closeModal('viewModal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS (ì§€ë„ ë¡œì§) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // --- 1. ì´ˆê¸° ë°ì´í„° ë° ì„¤ì • ---
        // LocalStorageì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
        let posts = JSON.parse(localStorage.getItem('mapPosts')) || [];
        
        // ì§€ë„ ì´ˆê¸°í™” (ê¸°ë³¸ ìœ„ì¹˜: ì„œìš¸ ì‹œì²­ ë¶€ê·¼)
        const map = L.map('map').setView([37.5665, 126.9780], 13);

        // OpenStreetMap íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // ë§ˆì»¤ë“¤ì„ ë‹´ì„ ë ˆì´ì–´ ê·¸ë£¹
        const markersLayer = L.layerGroup().addTo(map);

        // --- 2. ì£¼ìš” ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---

        // ì§€ë„ ë Œë”ë§: ì €ì¥ëœ í¬ìŠ¤íŠ¸ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œ
        function renderMapMarkers() {
            markersLayer.clearLayers(); // ê¸°ì¡´ ë§ˆì»¤ ì´ˆê¸°í™”
            posts.forEach(post => {
                const marker = L.marker([post.lat, post.lng]).addTo(markersLayer);
                
                // ë§ˆì»¤ í´ë¦­ ì‹œ ì¡°íšŒ ëª¨ë‹¬ ì—´ê¸°
                marker.on('click', () => {
                    openViewModal(post.id);
                });
            });
        }

        // í¬ìŠ¤íŠ¸ ì €ì¥ (LocalStorage ì—°ë™)
        function savePosts() {
            localStorage.setItem('mapPosts', JSON.stringify(posts));
            renderMapMarkers();
        }

        // ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
        function openCreateModal(lat, lng) {
            document.getElementById('clickLat').value = lat;
            document.getElementById('clickLng').value = lng;
            document.getElementById('postTitle').value = '';
            document.getElementById('postContent').value = '';
            document.getElementById('createModal').classList.remove('hidden');
        }

        function openViewModal(id) {
            const post = posts.find(p => p.id === id);
            if (!post) return;

            document.getElementById('currentPostId').value = post.id;
            document.getElementById('viewTitle').innerText = post.title;
            document.getElementById('viewContent').innerText = post.content;
            document.getElementById('viewDate').innerText = new Date(post.date).toLocaleString();
            
            renderComments(post);
            document.getElementById('viewModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function renderComments(post) {
            const list = document.getElementById('commentsList');
            const count = document.getElementById('commentCount');
            list.innerHTML = '';
            count.innerText = post.comments.length;

            if (post.comments.length === 0) {
                list.innerHTML = '<div class="text-sm text-gray-400 text-center py-2">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            post.comments.forEach(comment => {
                const div = document.createElement('div');
                div.className = 'bg-gray-100 p-2 rounded text-sm';
                div.innerHTML = `
                    <div class="text-gray-800">${comment.text}</div>
                    <div class="text-xs text-gray-400 text-right">${new Date(comment.date).toLocaleDateString()}</div>
                `;
                list.appendChild(div);
            });
        }

        // --- 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

        // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ -> ì‘ì„± ëª¨ë‹¬ ì—´ê¸°
        map.on('click', (e) => {
            openCreateModal(e.latlng.lat, e.latlng.lng);
        });

        // í¬ìŠ¤íŠ¸ ì‘ì„± í¼ ì œì¶œ
        document.getElementById('postForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const lat = parseFloat(document.getElementById('clickLat').value);
            const lng = parseFloat(document.getElementById('clickLng').value);

            const newPost = {
                id: Date.now(), // ìœ ë‹ˆí¬ IDë¡œ ì‹œê°„ ì‚¬ìš©
                lat,
                lng,
                title,
                content,
                date: new Date().toISOString(),
                comments: []
            };

            posts.push(newPost);
            savePosts();
            closeModal('createModal');
        });

        // ëŒ“ê¸€ ì‘ì„± í¼ ì œì¶œ
        document.getElementById('commentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const postId = parseInt(document.getElementById('currentPostId').value);
            const text = document.getElementById('commentInput').value;
            
            const postIndex = posts.findIndex(p => p.id === postId);
            if (postIndex !== -1) {
                posts[postIndex].comments.push({
                    text: text,
                    date: new Date().toISOString()
                });
                savePosts(); // ì €ì¥
                renderComments(posts[postIndex]); // ëŒ“ê¸€ì°½ ê°±ì‹ 
                document.getElementById('commentInput').value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
            }
        });

        // (ì¶”ê°€ ê¸°ëŠ¥) ê²Œì‹œê¸€ ì‚­ì œ
        window.deletePost = function() {
            if(!confirm('ì •ë§ ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const postId = parseInt(document.getElementById('currentPostId').value);
            posts = posts.filter(p => p.id !== postId);
            savePosts();
            closeModal('viewModal');
        }

        // ì´ˆê¸° ë Œë”ë§ ì‹¤í–‰
        renderMapMarkers();

    </script>
</body>
</html>
